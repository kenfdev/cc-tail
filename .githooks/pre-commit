#!/bin/sh
#
# Shared pre-commit hook for cc-tail
# Install: make setup
#

# ── Rust formatting (cargo fmt) ──
# Auto-fix formatting and re-stage affected files
if command -v cargo >/dev/null 2>&1; then
    RUST_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.rs')
    if [ -n "$RUST_FILES" ]; then
        echo "Running cargo fmt..."
        cargo fmt
        # Re-stage any files that were reformatted
        echo "$RUST_FILES" | xargs git add
    fi
fi

# ── Rust linting (cargo clippy) ──
if command -v cargo >/dev/null 2>&1; then
    RUST_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.rs')
    if [ -n "$RUST_FILES" ]; then
        echo "Running cargo clippy..."
        if ! cargo clippy -- -D warnings 2>&1; then
            echo "Error: cargo clippy found warnings. Fix them before committing." >&2
            exit 1
        fi
    fi
fi

exit 0
